<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Details - ESMS</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/style.css}" />
    <link rel="stylesheet" th:href="@{/css/navigationBar.css}" />
    <link rel="stylesheet" th:href="@{/css/viewProductDetail.css}" />
    <link rel="stylesheet" th:href="@{/css/feedback-customer.css}" />

</head>

<body>

    <div th:insert="~{fragments/navigationBar :: navBar}"></div>

    <div id="floatingMessage" class="floating-message">
        <i class="fas fa-check-circle me-2"></i>
        <span id="messageText"></span>
    </div>

    <div class="container main-content">
        <div class="row justify-content-center">
            <div class="col-lg-12 col-12">
                <div class="product-card">
                    <div class="product-header">
                        <div class="container">
                            <div class="row align-items-center">
                                <div class="col-md-7">
                                    <h1 class="product-title" th:text="${product.name}"></h1>
                                    <div class="product-subtitle" th:if="${product.category != null}">
                                        <a th:href="@{'/products/category/' + ${product.category.id}}"
                                            class="text-decoration-none">
                                            <span th:text="${product.category.name}"></span>
                                        </a>
                                        <span th:if="${product.brand != null}"> •
                                            <a th:href="@{'/products/brand/' + ${product.brand.id}}"
                                                class="text-decoration-none">
                                                <span th:text="${product.brand.name}"></span>
                                            </a>
                                        </span>
                                    </div>
                                </div>
                                <div class="col-md-5 text-md-end">
                                    <button type="button" class="btn btn-outline-secondary" onclick="history.back()">
                                        <i class="fas fa-arrow-left me-2"></i>Back to Products
                                    </button>
                                    <a href="#feedback-section" class="btn btn-warning ms-2">Xem đánh giá</a>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card-body">
                        <div class="row">
                            <!-- Product Images Column -->
                            <div class="col-lg-6 col-md-5 mb-5 mb-md-0">
                                <div class="product-image-container">
                                    <img th:if="${primaryImage}" th:src="${primaryImage}"
                                        class="product-main-image mb-4" alt="Main Product Image" id="mainProductImage">

                                    <div th:unless="${primaryImage}"
                                        class="d-flex flex-column align-items-center justify-content-center py-5">
                                        <i class="fas fa-image fa-4x text-secondary mb-3"></i>
                                        <p class="text-muted fs-5">No Image Available</p>
                                    </div>

                                    <div class="thumbnail-container mt-3">
                                        <div th:each="image : ${imageGallery}">
                                            <img th:src="${image.imageUrl}" th:class="${image.isPrimary} ?
                         'product-thumbnail active' :
                         'product-thumbnail'" onclick="changeMainImage(event)" alt="Product thumbnail">
                                        </div>
                                    </div>

                                    <div class="wishlist-container">
                                        <button class="wishlist-btn" id="wishlistBtn" onclick="toggleWishlist()">
                                            <i class="far fa-heart"></i>
                                        </button>
                                    </div>

                                    <div class="container">
                                        <div>
                                            <div class="commitment-title">
                                                <i class="fas fa-shield-alt"></i>
                                                <span>Product Commitment</span>
                                            </div>
                                            <div class="commitment-items">
                                                <div class="commitment-item">
                                                    <i class="fas fa-check-circle"></i>
                                                    <span>100% Authentic</span>
                                                </div>
                                                <div class="commitment-item">
                                                    <i class="fas fa-truck"></i>
                                                    <span>Free Shipping</span>
                                                </div>
                                                <div class="commitment-item">
                                                    <i class="fas fa-sync-alt"></i>
                                                    <span>7-Day Returns</span>
                                                </div>
                                                <div class="commitment-item">
                                                    <i class="fas fa-headset"></i>
                                                    <span>24/7 Support</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Product Info Column -->
                            <div class="col-lg-6 col-md-7">
                                <!-- Price and Discount -->
                                <div class="price-container mb-4">
                                    <div class="current-price">
                                        <span
                                            th:if="${discount != null and discount.discountPct != null and product.price != null}"
                                            th:text="${#numbers.formatDecimal(product.price * (100 - discount.discountPct) / 100, 0, 'POINT', 0, 'COMMA') + ' VND'}">
                                        </span>
                                        <span
                                            th:unless="${discount != null and discount.discountPct != null and product.price != null}"
                                            th:text="${#numbers.formatDecimal(product.price, 0, 'POINT', 0, 'COMMA') + ' VND'}">
                                        </span>
                                    </div>

                                    <div th:if="${discount != null and discount.discountPct != null and product.price != null}"
                                        class="original-price">
                                        <span
                                            th:text="${#numbers.formatDecimal(product.price, 0, 'POINT', 0, 'COMMA') + ' VND'}"></span>
                                    </div>

                                    <div th:if="${discount != null}" class="discount-badge">
                                        <i class="fas fa-tag me-1"></i>
                                        <span th:if="${discount.discountPct != null}"
                                            th:text="${#numbers.formatDecimal(discount.discountPct, 0, 'POINT', 0, 'COMMA')} + '% OFF'">
                                        </span>
                                    </div>
                                </div>

                                <div th:if="${discount != null}" class="mb-4">
                                    <span class="saving-badge">
                                        <i class="fas fa-piggy-bank me-1"></i>
                                        <span th:if="${discount.discountPct != null and product.price != null}"
                                            th:text="${'You save: ' + #numbers.formatDecimal(product.price * discount.discountPct / 100, 0, 'POINT', 0, 'COMMA')} + ' VND'">
                                        </span>
                                    </span>
                                </div>

                                <!-- Product Metadata -->
                                <div class="product-meta mb-4">
                                    <div class="meta-item">
                                        <span class="meta-label">Status:</span>
                                        <span class="meta-value">
                                            <span th:if="${product.status}" class="badge bg-success status-badge">In
                                                Stock</span>
                                            <span th:unless="${product.status}" class="badge bg-danger status-badge">Out
                                                of Stock</span>
                                        </span>
                                    </div>

                                    <div th:if="${product.brand != null}" class="meta-item">
                                        <span class="meta-label">Brand:</span>
                                        <span class="meta-value" th:text="${product.brand.name}"></span>
                                    </div>

                                    <div th:if="${product.category != null}" class="meta-item">
                                        <span class="meta-label">Category:</span>
                                        <span class="meta-value" th:text="${product.category.name}"></span>
                                    </div>

                                    <div class="meta-item">
                                        <span class="meta-label">Product ID:</span>
                                        <span class="meta-value" th:text="${product.productId}"></span>
                                    </div>

                                    <!-- Quick specifications preview -->
                                    <div th:if="${not #lists.isEmpty(specifications) and #lists.size(specifications) > 0}"
                                        class="meta-item">
                                        <span class="meta-label">Key Specs:</span>
                                        <span class="meta-value">
                                            <span th:each="spec, iterStat : ${specifications}"
                                                th:if="${iterStat.index < 2}">
                                                <span th:text="${spec.specKey + ': ' + spec.specValue}"></span>
                                                <span
                                                    th:if="${iterStat.index < 1 and #lists.size(specifications) > 1}">&bull;</span>
                                            </span>
                                            <a href="#specifications" class="ms-2 small text-primary">See all</a>
                                        </span>
                                    </div>
                                </div>

                                <!-- Delivery Address Section -->
                                <div class="delivery-section mb-4">
                                    <h5 class="mb-3"><i class="fas fa-truck me-2 text-primary"></i>Delivery Information
                                    </h5>
                                    <div class="card border-light bg-light">
                                        <div class="card-body p-3">
                                            <div th:if="${customer != null}">
                                                <div class="d-flex align-items-center mb-2">
                                                    <i class="fas fa-map-marker-alt text-danger me-2"></i>
                                                    <span class="fw-medium">Delivery Address</span>
                                                    <button class="ms-auto btn btn-sm btn-outline-primary"
                                                        onclick="openAddressModal()">Change
                                                    </button>
                                                </div>
                                                <p class="mb-2" id="displayed-address">
                                                    <span
                                                        th:text="${customer.address != null ? customer.address : 'No address provided'}"></span>
                                                    <span id="temporary-badge" class="temporary-badge"
                                                        style="display: none;">Temporary</span>
                                                </p>
                                                <p class="mb-0 text-muted small">Estimated delivery: 2-3 business days
                                                </p>

                                                <hr class="my-3">

                                                <div class="d-flex justify-content-between align-items-center">
                                                    <div class="d-flex">
                                                        <div class="me-3" id="shipping-info">
                                                            <i class="fas fa-truck text-primary me-2"></i>
                                                            <span class="fw-medium">Shipping fee: <span
                                                                    id="shipping-fee"
                                                                    th:text="${#numbers.formatDecimal(shippingCost, 0, 'POINT', 0, 'COMMA')} + ' VND'"></span></span>
                                                        </div>
                                                        <div>
                                                            <i class="fas fa-exchange-alt text-warning me-2"></i>
                                                            <span>7-day returns</span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>

                                            <div th:unless="${customer != null}" class="py-3">
                                                <div class="text-center mb-3">
                                                    <i class="fas fa-user-circle fa-2x text-secondary mb-2"></i>
                                                    <p class="mb-2">Please log in to save your delivery information</p>
                                                    <a href="/login" class="btn btn-sm btn-primary mb-3">Log In</a>
                                                </div>

                                                <div id="address-selection-form">
                                                    <h6 class="mb-3">Quick Shipping Estimate</h6>
                                                    <div class="mb-3">
                                                        <label for="province" class="form-label">Province/City</label>
                                                        <select id="province" class="form-select form-select-sm"
                                                            onchange="handleProvinceChange()">
                                                            <option value="">Select Province</option>
                                                            <!-- Will be populated by JavaScript -->
                                                        </select>
                                                    </div>
                                                    <div class="mb-3">
                                                        <label for="district" class="form-label">District</label>
                                                        <select id="district" class="form-select form-select-sm"
                                                            disabled>
                                                            <option value="">Select District</option>
                                                        </select>
                                                    </div>
                                                    <div class="text-center">
                                                        <p class="mt-3 mb-0" id="shipping-estimate">
                                                            <span class="text-muted">Select a province to see shipping
                                                                cost</span>
                                                        </p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Quantity Selector and Total Price -->
                                <div class="mb-5">
                                    <div class="row">
                                        <div class="col-md-5">
                                            <label for="quantity" class="form-label fw-medium">Quantity:</label>
                                            <div class="input-group quantity-selector" style="width: 135px;">
                                                <button type="button" class="btn btn-outline-secondary"
                                                    onclick="decrementQuantity()">
                                                    <i class="fas fa-minus"></i>
                                                </button>
                                                <input type="number" id="quantity" class="form-control text-center"
                                                    value="1" min="1" max="99">
                                                <button type="button" class="btn btn-outline-secondary"
                                                    onclick="incrementQuantity()">
                                                    <i class="fas fa-plus"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <div class="col-md-6 mt-3 mt-md-0">
                                            <div class="card bg-light border-0">
                                                <div class="card-body p-3">
                                                    <h6 class="mb-3 border-bottom pb-2">Order Summary</h6>
                                                    <div class="d-flex justify-content-between mb-2">
                                                        <span>Product Price:</span>
                                                        <span class="fw-medium product-price-display">
                                                            <span
                                                                th:if="${discount != null and discount.discountPct != null and product.price != null}"
                                                                th:text="${#numbers.formatDecimal(product.price * (100 - discount.discountPct) / 100, 0, 'POINT', 0, 'COMMA')} + ' VND'"
                                                                th:attr="data-price=${product.price * (100 - discount.discountPct) / 100}">
                                                            </span>
                                                            <span
                                                                th:unless="${discount != null and discount.discountPct != null and product.price != null}"
                                                                th:text="${#numbers.formatDecimal(product.price, 0, 'POINT', 0, 'COMMA')} + ' VND'"
                                                                th:attr="data-price=${product.price}">
                                                            </span>
                                                        </span>
                                                    </div>
                                                    <div class="d-flex justify-content-between mb-2">
                                                        <span>Shipping Fee:</span>
                                                        <span class="fw-medium shipping-cost" id="shipping-cost-display"
                                                            th:text="${#numbers.formatDecimal(shippingCost, 0, 'POINT', 0, 'COMMA')} + ' VND'"
                                                            th:attr="data-shipping=${shippingCost}"></span>
                                                    </div>
                                                    <div
                                                        class="d-flex justify-content-between fw-bold pt-2 border-top mt-2">
                                                        <span>Total:</span>
                                                        <span class="total-price"></span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Action Buttons -->
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <form th:action="@{/cart/add}" method="post" class="w-100" id="addToCartForm">
                                            <input type="hidden" name="productId" th:value="${product.productId}" />
                                            <input type="hidden" name="quantity" id="cartQuantity" value="1" />
                                            <button type="submit" class="btn btn-action btn-cart w-100" id="cartBtn">
                                                <i class="fas fa-shopping-cart me-2"></i>Add to Cart
                                            </button>
                                        </form>
                                    </div>
                                    <div class="col-md-6">
                                        <form th:action="@{/cart/add}" method="post" class="w-100">
                                            <input type="hidden" name="productId" th:value="${product.productId}" />
                                            <input type="hidden" name="quantity" id="buyQuantity" value="1" />
                                            <button type="submit" class="btn btn-action btn-buy w-100">
                                                <i class="fas fa-bolt me-2"></i>Buy Now
                                            </button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Specifications Section -->
                        <div id="specifications" class="specs-section" th:if="${not #lists.isEmpty(specifications)}">
                            <h3 class="section-title">Technical Specifications</h3>
                            <table class="specs-table">
                                <tr th:each="spec, specStat : ${specifications}"
                                    th:if="${specStat.index == 0 || !specifications[specStat.index-1].specKey.equals(spec.specKey)}">
                                    <th th:text="${spec.specKey}"></th>
                                    <td th:text="${spec.specValue}"></td>
                                </tr>
                            </table>
                        </div>

                        <!-- Description Section -->
                        <div class="description-section">
                            <h3 class="section-title">Product Description</h3>
                            <div class="description-content"
                                th:utext="${product.description != null ? product.description : 'No description available for this product.'}">
                            </div>
                        </div>
                        <!-- Feedback Section: include product-feedback.html -->
                        <div th:replace="~{customer/product-feedback :: #product-feedback-fragment}"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Address Selection Modal -->
    <div id="addressModal" class="address-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Select Delivery Address</h3>
                <span class="close-modal" onclick="closeAddressModal()">&times;</span>
            </div>

            <div class="modal-body">
                <!-- Default Address -->
                <div class="address-option" id="default-address" onclick="selectAddress(this)">
                    <div class="address-icon">
                        <i class="fas fa-home"></i>
                    </div>
                    <div class="address-text">
                        <h5>Default Address</h5>
                        <p id="default-address-text"
                            th:text="${customer.address != null ? customer.address : 'No default address set'}"></p>
                    </div>
                    <div class="address-actions">
                        <span class="badge bg-primary">Default</span>
                    </div>
                </div>

                <!-- Other Addresses -->
                <div class="address-option" id="new-address" onclick="selectAddress(this)">
                    <div class="address-icon">
                        <i class="fas fa-map-marker-alt"></i>
                    </div>
                    <div class="address-text">
                        <h5>Select New Address</h5>
                        <p>Choose a different delivery location for this order</p>
                        <p class="text-muted small mt-1">(This won't change your account default)</p>
                    </div>
                </div>

                <!-- Address Form (hidden by default) -->
                <div id="address-form" class="mt-4" style="display: none;">
                    <h5 class="mb-4">Enter Temporary Delivery Address</h5>
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        This address will only be used for this order and won't change your account settings.
                    </div>
                    <div class="mb-3">
                        <label for="new-province" class="form-label">Province/City</label>
                        <select id="new-province" class="form-select form-select-lg"
                            onchange="handleNewProvinceChange()">
                            <option value="">Select Province</option>
                            <!-- Will be populated by JavaScript -->
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="new-district" class="form-label">District</label>
                        <select id="new-district" class="form-select form-select-lg" disabled>
                            <option value="">Select District</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="new-street" class="form-label">Street Address</label>
                        <input type="text" id="new-street" class="form-control form-control-lg"
                            placeholder="Enter street address">
                    </div>
                    <div class="d-flex justify-content-end mt-4">
                        <button type="button" class="btn btn-outline-secondary me-2" onclick="cancelAddressChange()">
                            Cancel
                        </button>
                        <button type="button" class="btn btn-save-address" onclick="saveTemporaryAddress()">Use This
                            Address
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script th:inline="javascript">
        /*<![CDATA[*/
        window.productId = [[${product.productId}]];
        window.currentUserId = [[${customer != null ? customer.customerId : 'null'}]];
        /*]]>*/
    </script>
    <script th:src="@{/js/feedback.js}"></script>
</body>

</html>