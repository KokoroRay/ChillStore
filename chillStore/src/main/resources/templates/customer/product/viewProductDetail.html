<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Details - ESMS</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/static/style.css}" />
    <link rel="stylesheet" th:href="@{/css/navigationBar.css}" />
    <style>
        :root {
            --primary-color: #0d6efd;
            --secondary-color: #6c757d;
            --danger-color: #dc3545;
            --success-color: #198754;
            --light-bg: #f8f9fa;
            --border-color: #dee2e6;
        }

        .main-content {
            margin-top: 0;
            padding-bottom: 100px;
        }

        .product-card {
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            overflow: hidden;
            border: none;
        }

        .product-header {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 25px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .product-title {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
            color: #212529;
        }

        .product-subtitle {
            font-size: 1.1rem;
            color: var(--secondary-color);
            margin-bottom: 25px;
        }

        .product-image-container {
            background-color: white;
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .product-main-image {
            max-width: 100%;
            max-height: 500px;
            object-fit: contain;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .thumbnail-container {
            display: flex;
            gap: 12px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .product-thumbnail {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border: 2px solid transparent;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .product-thumbnail:hover,
        .product-thumbnail.active {
            border-color: var(--primary-color);
            transform: scale(1.05);
        }

        .price-container {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
        }

        .current-price {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--danger-color);
        }

        .original-price {
            font-size: 1.4rem;
            text-decoration: line-through;
            color: var(--secondary-color);
        }

        .discount-badge {
            font-size: 1.1rem;
            padding: 6px 14px;
            border-radius: 30px;
            background: linear-gradient(135deg, #ff6b6b 0%, #ff8e8e 100%);
            color: white;
            font-weight: 600;
        }

        .saving-badge {
            background-color: #e9f7ef;
            color: var(--success-color);
            padding: 5px 12px;
            border-radius: 4px;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .product-meta {
            background-color: var(--light-bg);
            border-radius: 8px;
            padding: 30px;
            margin-bottom: 25px;
        }

        .meta-item {
            display: flex;
            margin-bottom: 12px;
        }

        .meta-label {
            font-weight: 600;
            min-width: 120px;
            color: var(--secondary-color);
        }

        .meta-value {
            font-weight: 500;
        }

        .status-badge {
            font-size: 0.95rem;
            padding: 5px 12px;
            border-radius: 30px;
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-top: 30px;
        }

        .btn-action {
            flex: 1;
            min-width: 150px;
            padding: 15px 25px;
            font-weight: 600;
            border-radius: 8px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-cart {
            background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%);
            border: none;
            color: #212529;
        }

        .btn-buy {
            background: linear-gradient(135deg, var(--primary-color) 0%, #0b5ed7 100%);
            border: none;
            color: white;
        }

        .btn-back {
            background-color: white;
            border: 1px solid var(--border-color);
            color: var(--secondary-color);
        }

        .specs-section {
            margin-top: 40px;
            background-color: white;
            border-radius: 12px;
            padding: 40px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }

        .section-title {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--primary-color);
            display: inline-block;
        }

        .specs-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
        }

        .specs-table th {
            background-color: var(--light-bg);
            font-weight: 600;
            padding: 14px 20px;
            text-align: left;
            width: 30%;
            border-bottom: 1px solid var(--border-color);
        }

        .specs-table td {
            padding: 14px 20px;
            border-bottom: 1px solid var(--border-color);
            background-color: white;
        }

        .specs-table tr:last-child th,
        .specs-table tr:last-child td {
            border-bottom: none;
        }

        .description-section {
            margin-top: 30px;
            padding: 40px;
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            line-height: 1.7;
        }

        .description-content {
            white-space: pre-line;
            font-size: 1.1rem;
        }

        /* Modal for address selection */
        .address-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            z-index: 1050;
            overflow-y: auto;
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 700px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        }

        .modal-header {
            border-bottom: 1px solid #dee2e6;
            padding-bottom: 15px;
            margin-bottom: 20px;
        }

        .close-modal {
            font-size: 1.5rem;
            cursor: pointer;
            color: #6c757d;
        }

        .address-option {
            display: flex;
            align-items: center;
            padding: 15px;
            margin-bottom: 10px;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .address-option:hover {
            border-color: var(--primary-color);
            background-color: #f8f9fa;
        }

        .address-option.selected {
            border-color: var(--primary-color);
            background-color: #e7f0ff;
        }

        .address-icon {
            font-size: 1.5rem;
            margin-right: 15px;
            color: var(--primary-color);
        }

        .address-text {
            flex-grow: 1;
        }

        .address-actions {
            display: flex;
            gap: 10px;
        }

        .btn-save-address {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            font-weight: 500;
            transition: background-color 0.2s;
        }

        .btn-save-address:hover {
            background-color: #0b5ed7;
        }

        .temporary-badge {
            background-color: #ffc107;
            color: #212529;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            margin-left: 10px;
        }

        /* Responsive adjustments */
        @media (max-width: 992px) {
            .product-title {
                font-size: 2.0rem;
            }

            .current-price {
                font-size: 2.0rem;
            }

            .original-price {
                font-size: 1.3rem;
            }
        }

        @media (max-width: 768px) {
            .product-main-image {
                max-height: 350px;
            }

            .action-buttons {
                flex-direction: column;
            }

            .btn-action {
                width: 100%;
            }
        }

        @media (max-width: 576px) {
            .product-title {
                font-size: 1.8rem;
            }

            .product-main-image {
                max-height: 280px;
            }

            .meta-item {
                flex-direction: column;
                gap: 5px;
            }

            .meta-label {
                min-width: auto;
            }

            .modal-content {
                padding: 15px;
                width: 95%;
                margin: 10% auto;
            }
        }
    </style>
</head>
<body>

<div th:insert="~{fragments/navigationBar :: navBar}"></div>

<div class="container main-content">
    <div class="row justify-content-center">
        <div class="col-lg-12 col-12">
            <div class="product-card">
                <div class="product-header">
                    <div class="container">
                        <div class="row align-items-center">
                            <div class="col-md-7">
                                <h1 class="product-title" th:text="${product.name}"></h1>
                                <div class="product-subtitle" th:if="${product.category != null}">
                                    <a th:href="@{'/products/category/' + ${product.category.id}}" class="text-decoration-none">
                                        <span th:text="${product.category.name}"></span>
                                    </a>
                                    <span th:if="${product.brand != null}"> •
                                        <a th:href="@{'/products/brand/' + ${product.brand.id}}" class="text-decoration-none">
                                            <span th:text="${product.brand.name}"></span>
                                        </a>
                                    </span>
                                </div>
                            </div>
                            <div class="col-md-5 text-md-end">
                                <button type="button" class="btn btn-outline-secondary" onclick="history.back()">
                                    <i class="fas fa-arrow-left me-2"></i>Back to Products
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card-body">
                    <div class="row">
                        <!-- Product Images Column -->
                        <div class="col-lg-6 col-md-5 mb-5 mb-md-0">
                            <div class="product-image-container">
                                <img th:if="${primaryImage}"
                                     th:src="${primaryImage}"
                                     class="product-main-image mb-4"
                                     alt="Main Product Image"
                                     id="mainProductImage">

                                <div th:unless="${primaryImage}" class="d-flex flex-column align-items-center justify-content-center py-5">
                                    <i class="fas fa-image fa-4x text-secondary mb-3"></i>
                                    <p class="text-muted fs-5">No Image Available</p>
                                </div>

                                <div class="thumbnail-container mt-3">
                                    <div th:each="image : ${imageGallery}">
                                        <img th:src="${image.imageUrl}"
                                             th:class="${image.isPrimary} ?
                                                 'product-thumbnail active' :
                                                 'product-thumbnail'"
                                             onclick="changeMainImage(event)"
                                             alt="Product thumbnail">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Product Info Column -->
                        <div class="col-lg-6 col-md-7">
                            <!-- Price and Discount -->
                            <div class="price-container mb-4">
                                <div class="current-price">
                                    <span th:if="${discount != null and discount.discountPct != null and product.price != null}"
                                          th:text="${#numbers.formatDecimal(product.price * (100 - discount.discountPct) / 100, 0, 'POINT', 0, 'COMMA') + ' VND'}">
                                    </span>
                                    <span th:unless="${discount != null and discount.discountPct != null and product.price != null}"
                                          th:text="${#numbers.formatDecimal(product.price, 0, 'POINT', 0, 'COMMA') + ' VND'}">
                                    </span>
                                </div>

                                <div th:if="${discount != null and discount.discountPct != null and product.price != null}"
                                     class="original-price">
                                    <span th:text="${#numbers.formatDecimal(product.price, 0, 'POINT', 0, 'COMMA') + ' VND'}"></span>
                                </div>

                                <div th:if="${discount != null}" class="discount-badge">
                                    <i class="fas fa-tag me-1"></i>
                                    <span th:if="${discount.discountPct != null}"
                                          th:text="${#numbers.formatDecimal(discount.discountPct, 0, 'POINT', 0, 'COMMA')} + '% OFF'">
                                    </span>
                                </div>
                            </div>

                            <div th:if="${discount != null}" class="mb-4">
                                <span class="saving-badge">
                                    <i class="fas fa-piggy-bank me-1"></i>
                                    <span th:if="${discount.discountPct != null and product.price != null}"
                                          th:text="${'You save: ' + #numbers.formatDecimal(product.price * discount.discountPct / 100, 0, 'POINT', 0, 'COMMA')} + ' VND'">
                                    </span>
                                </span>
                            </div>

                            <!-- Product Metadata -->
                            <div class="product-meta mb-4">
                                <div class="meta-item">
                                    <span class="meta-label">Status:</span>
                                    <span class="meta-value">
                                        <span th:if="${product.status}" class="badge bg-success status-badge">In Stock</span>
                                        <span th:unless="${product.status}" class="badge bg-danger status-badge">Out of Stock</span>
                                    </span>
                                </div>

                                <div th:if="${product.brand != null}" class="meta-item">
                                    <span class="meta-label">Brand:</span>
                                    <span class="meta-value" th:text="${product.brand.name}"></span>
                                </div>

                                <div th:if="${product.category != null}" class="meta-item">
                                    <span class="meta-label">Category:</span>
                                    <span class="meta-value" th:text="${product.category.name}"></span>
                                </div>

                                <div class="meta-item">
                                    <span class="meta-label">Product ID:</span>
                                    <span class="meta-value" th:text="${product.productId}"></span>
                                </div>

                                <!-- Quick specifications preview -->
                                <div th:if="${not #lists.isEmpty(specifications) and #lists.size(specifications) > 0}" class="meta-item">
                                    <span class="meta-label">Key Specs:</span>
                                    <span class="meta-value">
                                        <span th:each="spec, iterStat : ${specifications}" th:if="${iterStat.index < 2}">
                                            <span th:text="${spec.specKey + ': ' + spec.specValue}"></span>
                                            <span th:if="${iterStat.index < 1 and #lists.size(specifications) > 1}">&bull;</span>
                                        </span>
                                        <a href="#specifications" class="ms-2 small text-primary">See all</a>
                                    </span>
                                </div>
                            </div>

                            <!-- Delivery Address Section -->
                            <div class="delivery-section mb-4">
                                <h5 class="mb-3"><i class="fas fa-truck me-2 text-primary"></i>Delivery Information</h5>
                                <div class="card border-light bg-light">
                                    <div class="card-body p-3">
                                        <div th:if="${customer != null}">
                                            <div class="d-flex align-items-center mb-2">
                                                <i class="fas fa-map-marker-alt text-danger me-2"></i>
                                                <span class="fw-medium">Delivery Address</span>
                                                <button class="ms-auto btn btn-sm btn-outline-primary" onclick="openAddressModal()">Change</button>
                                            </div>
                                            <p class="mb-2" id="displayed-address">
                                                <span th:text="${customer.address != null ? customer.address : 'No address provided'}"></span>
                                                <span id="temporary-badge" class="temporary-badge" style="display: none;">Temporary</span>
                                            </p>
                                            <p class="mb-0 text-muted small">Estimated delivery: 2-3 business days</p>

                                            <hr class="my-3">

                                            <div class="d-flex justify-content-between align-items-center">
                                                <div class="d-flex">
                                                    <div class="me-3" id="shipping-info">
                                                        <i class="fas fa-truck text-primary me-2"></i>
                                                        <span class="fw-medium">Shipping fee: <span id="shipping-fee" th:text="${#numbers.formatDecimal(shippingCost, 0, 'POINT', 0, 'COMMA')} + ' VND'"></span></span>
                                                    </div>
                                                    <div>
                                                        <i class="fas fa-exchange-alt text-warning me-2"></i>
                                                        <span>7-day returns</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <div th:unless="${customer != null}" class="py-3">
                                            <div class="text-center mb-3">
                                                <i class="fas fa-user-circle fa-2x text-secondary mb-2"></i>
                                                <p class="mb-2">Please log in to save your delivery information</p>
                                                <a href="/login" class="btn btn-sm btn-primary mb-3">Log In</a>
                                            </div>

                                            <div id="address-selection-form">
                                                <h6 class="mb-3">Quick Shipping Estimate</h6>
                                                <div class="mb-3">
                                                    <label for="province" class="form-label">Province/City</label>
                                                    <select id="province" class="form-select form-select-sm" onchange="handleProvinceChange()">
                                                        <option value="">Select Province</option>
                                                        <!-- Will be populated by JavaScript -->
                                                    </select>
                                                </div>
                                                <div class="mb-3">
                                                    <label for="district" class="form-label">District</label>
                                                    <select id="district" class="form-select form-select-sm" disabled>
                                                        <option value="">Select District</option>
                                                    </select>
                                                </div>
                                                <div class="text-center">
                                                    <p class="mt-3 mb-0" id="shipping-estimate">
                                                        <span class="text-muted">Select a province to see shipping cost</span>
                                                    </p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Quantity Selector and Total Price -->
                            <div class="mb-4">
                                <div class="row">
                                    <div class="col-md-6">
                                        <label for="quantity" class="form-label fw-medium">Quantity:</label>
                                        <div class="input-group quantity-selector" style="width: 140px;">
                                            <button type="button" class="btn btn-outline-secondary" onclick="decrementQuantity()">
                                                <i class="fas fa-minus"></i>
                                            </button>
                                            <input type="number" id="quantity" class="form-control text-center" value="1" min="1" max="99">
                                            <button type="button" class="btn btn-outline-secondary" onclick="incrementQuantity()">
                                                <i class="fas fa-plus"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="col-md-6 mt-3 mt-md-0">
                                        <div class="card bg-light border-0">
                                            <div class="card-body p-3">
                                                <h6 class="mb-3 border-bottom pb-2">Order Summary</h6>
                                                <div class="d-flex justify-content-between mb-2">
                                                    <span>Product Price:</span>
                                                    <span class="fw-medium product-price-display">
                                                            <span th:if="${discount != null and discount.discountPct != null and product.price != null}"
                                                                  th:text="${#numbers.formatDecimal(product.price * (100 - discount.discountPct) / 100, 0, 'POINT', 0, 'COMMA')} + ' VND'"
                                                                  th:attr="data-price=${product.price * (100 - discount.discountPct) / 100}">
                                                            </span>
                                                            <span th:unless="${discount != null and discount.discountPct != null and product.price != null}"
                                                                  th:text="${#numbers.formatDecimal(product.price, 0, 'POINT', 0, 'COMMA')} + ' VND'"
                                                                  th:attr="data-price=${product.price}">
                                                            </span>
                                                        </span>
                                                </div>
                                                <div class="d-flex justify-content-between mb-2">
                                                    <span>Shipping Fee:</span>
                                                    <span class="fw-medium shipping-cost" id="shipping-cost-display" th:text="${#numbers.formatDecimal(shippingCost, 0, 'POINT', 0, 'COMMA')} + ' VND'" th:attr="data-shipping=${shippingCost}"></span>
                                                </div>
                                                <div class="d-flex justify-content-between fw-bold pt-2 border-top mt-2">
                                                    <span>Total:</span>
                                                    <span class="total-price"></span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Action Buttons -->
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <form th:action="@{/cart/add}" method="post" class="w-100">
                                        <input type="hidden" name="productId" th:value="${product.productId}" />
                                        <input type="hidden" name="quantity" id="cartQuantity" value="1" />
                                        <button type="submit" class="btn btn-action btn-cart w-100">
                                            <i class="fas fa-shopping-cart me-2"></i>Add to Cart
                                        </button>
                                    </form>
                                </div>
                                <div class="col-md-6">
                                    <form th:action="@{/cart/add}" method="post" class="w-100">
                                        <input type="hidden" name="productId" th:value="${product.productId}" />
                                        <input type="hidden" name="quantity" id="buyQuantity" value="1" />
                                        <button type="submit" class="btn btn-action btn-buy w-100">
                                            <i class="fas fa-bolt me-2"></i>Buy Now
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Specifications Section -->
                    <div id="specifications" class="specs-section" th:if="${not #lists.isEmpty(specifications)}">
                        <h3 class="section-title">Technical Specifications</h3>
                        <table class="specs-table">
                            <tr th:each="spec, specStat : ${specifications}"
                                th:if="${specStat.index == 0 || !specifications[specStat.index-1].specKey.equals(spec.specKey)}">
                                <th th:text="${spec.specKey}"></th>
                                <td th:text="${spec.specValue}"></td>
                            </tr>
                        </table>
                    </div>

                    <!-- Description Section -->
                    <div class="description-section">
                        <h3 class="section-title">Product Description</h3>
                        <div class="description-content" th:utext="${product.description != null ? product.description : 'No description available for this product.'}"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Address Selection Modal -->
<div id="addressModal" class="address-modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">Select Delivery Address</h3>
            <span class="close-modal" onclick="closeAddressModal()">&times;</span>
        </div>

        <div class="modal-body">
            <!-- Default Address -->
            <div class="address-option" id="default-address" onclick="selectAddress(this)">
                <div class="address-icon">
                    <i class="fas fa-home"></i>
                </div>
                <div class="address-text">
                    <h5>Default Address</h5>
                    <p id="default-address-text" th:text="${customer.address != null ? customer.address : 'No default address set'}"></p>
                </div>
                <div class="address-actions">
                    <span class="badge bg-primary">Default</span>
                </div>
            </div>

            <!-- Other Addresses -->
            <div class="address-option" id="new-address" onclick="selectAddress(this)">
                <div class="address-icon">
                    <i class="fas fa-map-marker-alt"></i>
                </div>
                <div class="address-text">
                    <h5>Select New Address</h5>
                    <p>Choose a different delivery location for this order</p>
                    <p class="text-muted small mt-1">(This won't change your account default)</p>
                </div>
            </div>

            <!-- Address Form (hidden by default) -->
            <div id="address-form" class="mt-4" style="display: none;">
                <h5 class="mb-4">Enter Temporary Delivery Address</h5>
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    This address will only be used for this order and won't change your account settings.
                </div>
                <div class="mb-3">
                    <label for="new-province" class="form-label">Province/City</label>
                    <select id="new-province" class="form-select form-select-lg" onchange="handleNewProvinceChange()">
                        <option value="">Select Province</option>
                        <!-- Will be populated by JavaScript -->
                    </select>
                </div>
                <div class="mb-3">
                    <label for="new-district" class="form-label">District</label>
                    <select id="new-district" class="form-select form-select-lg" disabled>
                        <option value="">Select District</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label for="new-street" class="form-label">Street Address</label>
                    <input type="text" id="new-street" class="form-control form-control-lg" placeholder="Enter street address">
                </div>
                <div class="d-flex justify-content-end mt-4">
                    <button type="button" class="btn btn-outline-secondary me-2" onclick="cancelAddressChange()">Cancel</button>
                    <button type="button" class="btn btn-save-address" onclick="saveTemporaryAddress()">Use This Address</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // Function to change main product image
    function changeMainImage(event) {
        const mainImage = document.getElementById('mainProductImage');
        mainImage.src = event.target.src;
        mainImage.alt = event.target.alt;

        // Update active thumbnail
        document.querySelectorAll('.product-thumbnail').forEach(img => {
            img.classList.remove('active');
        });
        event.target.classList.add('active');

        // Smooth transition effect
        mainImage.style.opacity = 0;
        setTimeout(() => {
            mainImage.style.opacity = 1;
            mainImage.style.transition = 'opacity 0.3s ease';
        }, 10);
    }

    // Quantity selector functionality
    function decrementQuantity() {
        const input = document.getElementById('quantity');
        const currentValue = parseInt(input.value);
        if (currentValue > 1) {
            input.value = currentValue - 1;
            updateFormQuantities(currentValue - 1);
            updateTotalPrice(currentValue - 1);
        }
    }

    function incrementQuantity() {
        const input = document.getElementById('quantity');
        const currentValue = parseInt(input.value);
        if (currentValue < 99) {
            input.value = currentValue + 1;
            updateFormQuantities(currentValue + 1);
            updateTotalPrice(currentValue + 1);
        }
    }

    function updateFormQuantities(value) {
        document.getElementById('cartQuantity').value = value;
        document.getElementById('buyQuantity').value = value;
    }

    function updateTotalPrice(quantity) {
        // Get product price
        const priceElement = document.querySelector('.product-price-display span');
        const productPrice = parseFloat(priceElement.getAttribute('data-price'));

        // Get shipping cost
        const shippingElement = document.getElementById('shipping-cost-display');
        const shippingCost = parseFloat(shippingElement.getAttribute('data-shipping'));

        // Calculate total
        const total = (productPrice * quantity) + shippingCost;

        // Format with comma for thousands
        const formattedTotal = new Intl.NumberFormat('vi-VN').format(total);

        // Update total price display
        document.querySelector('.total-price').textContent = formattedTotal + ' VND';
    }

    // Initialize quantity change event listener
    document.addEventListener('DOMContentLoaded', function() {
        const quantityInput = document.getElementById('quantity');

        // Calculate initial total price
        updateTotalPrice(1);

        quantityInput.addEventListener('change', function() {
            let value = parseInt(this.value);
            if (isNaN(value) || value < 1) value = 1;
            if (value > 99) value = 99;
            this.value = value;
            updateFormQuantities(value);
            updateTotalPrice(value);
        });

        // Smooth scroll to specifications when clicking the "See all" link
        const specLink = document.querySelector('a[href="#specifications"]');
        if (specLink) {
            specLink.addEventListener('click', function(e) {
                e.preventDefault();
                document.getElementById('specifications').scrollIntoView({
                    behavior: 'smooth'
                });
            });
        }

        // Add province selector for guest users or when customer address is empty
        initializeAddressSelector();
    });

    function initializeAddressSelector() {
        // If there's a custom address selection form, initialize province API
        const addressForm = document.getElementById('address-selection-form');
        if (addressForm) {
            loadProvinces();
        }
    }

    // Address Modal Functions
    function openAddressModal() {
        document.getElementById('addressModal').style.display = 'block';
    }

    function closeAddressModal() {
        document.getElementById('addressModal').style.display = 'none';
    }

    function selectAddress(element) {
        // Remove selected class from all options
        document.querySelectorAll('.address-option').forEach(opt => {
            opt.classList.remove('selected');
        });

        // Add selected class to clicked option
        element.classList.add('selected');

        // If "New Address" is selected, show the form
        if (element.id === 'new-address') {
            document.getElementById('address-form').style.display = 'block';
            loadNewProvinces();
        } else {
            document.getElementById('address-form').style.display = 'none';
        }
    }

    function cancelAddressChange() {
        document.getElementById('address-form').style.display = 'none';
        document.querySelectorAll('.address-option').forEach(opt => {
            opt.classList.remove('selected');
        });
    }

    function saveTemporaryAddress() {
        const province = document.getElementById('new-province');
        const district = document.getElementById('new-district');
        const street = document.getElementById('new-street');

        if (!province.value || !district.value || !street.value) {
            alert('Please fill in all address fields');
            return;
        }

        const provinceText = province.options[province.selectedIndex].text;
        const districtText = district.options[district.selectedIndex].text;
        const fullAddress = `${street.value}, ${districtText}, ${provinceText}`;

        // Update displayed address
        document.getElementById('displayed-address').innerHTML =
            `<span>${fullAddress}</span> <span class="temporary-badge">Temporary</span>`;

        // Show temporary badge
        document.getElementById('temporary-badge').style.display = 'inline';

        // Calculate new shipping cost
        const newShippingCost = calculateShippingCostByProvince(provinceText);

        // Update shipping cost display
        const formattedShipping = new Intl.NumberFormat('vi-VN').format(newShippingCost);
        document.getElementById('shipping-fee').textContent = formattedShipping + ' VND';
        document.getElementById('shipping-cost-display').textContent = formattedShipping + ' VND';
        document.getElementById('shipping-cost-display').setAttribute('data-shipping', newShippingCost);

        // Update shipping info display
        if (newShippingCost === 0) {
            document.getElementById('shipping-info').innerHTML = `
                <i class="fas fa-check-circle text-success me-2"></i>
                <span class="fw-medium text-success">Free shipping</span>
            `;
        } else {
            document.getElementById('shipping-info').innerHTML = `
                <i class="fas fa-truck text-primary me-2"></i>
                <span class="fw-medium">Shipping fee: <span>${formattedShipping} VND</span></span>
            `;
        }

        // Update total price
        const quantity = parseInt(document.getElementById('quantity').value);
        updateTotalPrice(quantity);

        // Close modal
        closeAddressModal();
    }

    function calculateShippingCostByProvince(province) {
        // Simplified shipping cost calculation
        const provinceLower = province.toLowerCase();

        if (provinceLower.includes("cần thơ") || provinceLower.includes("can tho")) {
            return 0;
        }

        // List of northern provinces
        const northernProvinces = [
            "hà nội", "hanoi", "hải phòng", "haiphong", "bắc ninh", "bắc giang", "lào cai",
            "lao cai", "điện biên", "dien bien", "hòa bình", "hoa binh", "lai châu", "lai chau",
            "sơn la", "son la", "hà giang", "ha giang", "cao bằng", "cao bang", "bắc kạn", "bac kan",
            "lạng sơn", "lang son", "tuyên quang", "tuyen quang", "thái nguyên", "thai nguyen",
            "phú thọ", "phu tho", "vĩnh phúc", "vinh phuc", "quảng ninh", "quang ninh",
            "hải dương", "hai duong", "hưng yên", "hung yen", "thái bình", "thai binh",
            "hà nam", "ha nam", "nam định", "nam dinh", "ninh bình", "ninh binh", "thanh hóa", "thanh hoa"
        ];

        // Check if province is in northern list
        const isNorthern = northernProvinces.some(p => provinceLower.includes(p));

        return isNorthern ? 40000 : 20000;
    }

    async function loadNewProvinces() {
        try {
            const response = await fetch('https://provinces.open-api.vn/api/?depth=1');
            const data = await response.json();
            const provinceSelect = document.getElementById('new-province');

            if (provinceSelect) {
                provinceSelect.innerHTML = '<option value="">Select Province</option>';
                data.forEach(province => {
                    const option = document.createElement('option');
                    option.value = province.code;
                    option.textContent = province.name;
                    provinceSelect.appendChild(option);
                });
            }
        } catch (error) {
            console.error('Error loading provinces:', error);
        }
    }

    async function handleNewProvinceChange() {
        const provinceSelect = document.getElementById('new-province');
        const districtSelect = document.getElementById('new-district');
        const provinceCode = provinceSelect.value;

        if (!provinceCode) {
            districtSelect.disabled = true;
            districtSelect.innerHTML = '<option value="">Select District</option>';
            return;
        }

        try {
            const response = await fetch(`https://provinces.open-api.vn/api/p/${provinceCode}?depth=2`);
            const provinceData = await response.json();

            districtSelect.innerHTML = '<option value="">Select District</option>';
            provinceData.districts.forEach(district => {
                const option = document.createElement('option');
                option.value = district.code;
                option.textContent = district.name;
                districtSelect.appendChild(option);
            });

            districtSelect.disabled = false;
        } catch (error) {
            console.error('Error loading districts:', error);
        }
    }

    // Close modal when clicking outside
    window.onclick = function(event) {
        const modal = document.getElementById('addressModal');
        if (event.target === modal) {
            closeAddressModal();
        }
    }
</script>
</body>
</html>