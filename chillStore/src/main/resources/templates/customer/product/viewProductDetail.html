<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Details - ESMS</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/static/style.css}" />
    <link rel="stylesheet" th:href="@{/css/navigationBar.css}" />
    <link rel="stylesheet" th:href="@{/css/viewProductDetail.css}" />

</head>

<body>

    <div th:insert="~{fragments/navigationBar :: navBar}"></div>

    <div id="floatingMessage" class="floating-message">
        <i class="fas fa-check-circle me-2"></i>
        <span id="messageText"></span>
    </div>

    <div class="container main-content">
        <div class="row justify-content-center">
            <div class="col-lg-12 col-12">
                <div class="product-card">
                    <div class="product-header">
                        <div class="container">
                            <div class="row align-items-center">
                                <div class="col-md-8">
                                    <h1 class="product-title" th:text="${product.name}"></h1>
                                    <div class="meta-item">
                                        <span class="">Sold: </span>
                                        <span class="meta-value" th:text="${soldQuantity}"></span>
                                        <span class="meta-value">
                                            <a href="#specifications" class="ms-2 small text-primary">Specifications</a>
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card-body">
                        <div class="row">
                            <!-- Product Images Column -->
                            <div class="col-lg-6 col-md-5 mb-5 mb-md-0">
                                <div class="product-image-container">
                                    <img th:if="${primaryImage}" th:src="${primaryImage}"
                                        class="product-main-image mb-4" alt="Main Product Image" id="mainProductImage">

                                    <div th:unless="${primaryImage}"
                                        class="d-flex flex-column align-items-center justify-content-center py-5">
                                        <i class="fas fa-image fa-4x text-secondary mb-3"></i>
                                        <p class="text-muted fs-5">No Image Available</p>
                                    </div>

                                    <div class="thumbnail-container mt-3">
                                        <div th:each="image : ${imageGallery}">
                                            <img th:src="${image.imageUrl}" th:class="${image.isPrimary} ?
                         'product-thumbnail active' :
                         'product-thumbnail'" onclick="changeMainImage(event)" alt="Product thumbnail">
                                        </div>
                                    </div>

                                    <div class="wishlist-container">
                                        <button class="wishlist-btn" id="wishlistBtn" onclick="toggleWishlist()" type="button">
                                            <i class="far fa-heart"></i>
                                        </button>
                                    </div>

                                    <div class="container">
                                        <div>
                                            <div class="commitment-title">
                                                <i class="fas fa-shield-alt"></i>
                                                <span>Product Commitment</span>
                                            </div>
                                            <div class="commitment-items">
                                                <div class="commitment-item">
                                                    <i class="fas fa-check-circle"></i>
                                                    <span>100% Authentic</span>
                                                </div>
                                                <div class="commitment-item">
                                                    <i class="fas fa-truck"></i>
                                                    <span>Free Shipping</span>
                                                </div>
                                                <div class="commitment-item">
                                                    <i class="fas fa-sync-alt"></i>
                                                    <span>7-Day Returns</span>
                                                </div>
                                                <div class="commitment-item">
                                                    <i class="fas fa-headset"></i>
                                                    <span>24/7 Support</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Product Info Column -->
                            <div class="col-lg-6 col-md-7">
                                <!-- Price and Discount -->
                                <div class="price-container mb-4">
                                    <div class="current-price">
                                        <span
                                            th:if="${discount != null and discount.discountPct != null and product.price != null}"
                                            th:text="${#numbers.formatDecimal(product.price * (100 - discount.discountPct) / 100, 0, 'POINT', 0, 'COMMA') + ' VND'}">
                                        </span>
                                        <span
                                            th:unless="${discount != null and discount.discountPct != null and product.price != null}"
                                            th:text="${#numbers.formatDecimal(product.price, 0, 'POINT', 0, 'COMMA') + ' VND'}">
                                        </span>
                                    </div>

                                    <div th:if="${discount != null and discount.discountPct != null and product.price != null}"
                                        class="original-price">
                                        <span
                                            th:text="${#numbers.formatDecimal(product.price, 0, 'POINT', 0, 'COMMA') + ' VND'}"></span>
                                    </div>

                                    <div th:if="${discount != null}" class="discount-badge">
                                        <i class="fas fa-tag me-1"></i>
                                        <span th:if="${discount.discountPct != null}"
                                            th:text="${#numbers.formatDecimal(discount.discountPct, 0, 'POINT', 0, 'COMMA')} + '% OFF'">
                                        </span>
                                    </div>
                                </div>

                                <div th:if="${discount != null}" class="mb-4">
                                    <span class="saving-badge">
                                        <i class="fas fa-piggy-bank me-1"></i>
                                        <span th:if="${discount.discountPct != null and product.price != null}"
                                            th:text="${'You save: ' + #numbers.formatDecimal(product.price * discount.discountPct / 100, 0, 'POINT', 0, 'COMMA')} + ' VND'">
                                        </span>
                                    </span>
                                </div>

                                    <!-- Quick specifications preview -->



                                <!-- Delivery Address Section -->
                                <div class="delivery-section mb-4">
                                    <h5 class="mb-3"><i class="fas fa-truck me-2 text-primary"></i>Delivery Information
                                    </h5>
                                    <div class="card border-light bg-light">
                                        <div class="card-body p-3">
                                            <div th:if="${customer != null}">
                                                <div class="d-flex align-items-center mb-2">
                                                    <i class="fas fa-map-marker-alt text-danger me-2"></i>
                                                    <span class="fw-medium">Delivery Address</span>
                                                    <button class="ms-auto btn btn-sm btn-outline-primary"
                                                        onclick="openAddressModal()">Change
                                                    </button>
                                                </div>
                                                <p class="mb-2" id="displayed-address">
                                                    <span
                                                        th:text="${customer.address != null ? customer.address : 'No address provided'}"></span>
                                                    <span id="temporary-badge" class="temporary-badge"
                                                        style="display: none;">Temporary</span>
                                                </p>
                                                <p class="mb-0 text-muted small">Estimated delivery: 2-3 business days
                                                </p>

                                                <hr class="my-3">

                                                <div class="d-flex justify-content-between align-items-center">
                                                    <div class="d-flex">
                                                        <div class="me-3" id="shipping-info">
                                                            <i class="fas fa-truck text-primary me-2"></i>
                                                            <span class="fw-medium">Shipping fee: <span
                                                                    id="shipping-fee"
                                                                    th:text="${#numbers.formatDecimal(shippingCost, 0, 'POINT', 0, 'COMMA')} + ' VND'"></span></span>
                                                        </div>
                                                        <div>
                                                            <i class="fas fa-exchange-alt text-warning me-2"></i>
                                                            <span>7-day returns</span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>

                                            <div th:unless="${customer != null}" class="py-3">
                                                <div class="text-center mb-3">
                                                    <i class="fas fa-user-circle fa-2x text-secondary mb-2"></i>
                                                    <p class="mb-2">Please log in to save your delivery information</p>
                                                    <a href="/login" class="btn btn-sm btn-primary mb-3">Log In</a>
                                                </div>

                                                <div id="address-selection-form">
                                                    <h6 class="mb-3">Quick Shipping Estimate</h6>
                                                    <div class="mb-3">
                                                        <label for="province" class="form-label">Province/City</label>
                                                        <select id="province" class="form-select form-select-sm"
                                                            onchange="handleProvinceChange()">
                                                            <option value="">Select Province</option>
                                                            <!-- Will be populated by JavaScript -->
                                                        </select>
                                                    </div>
                                                    <div class="mb-3">
                                                        <label for="district" class="form-label">District</label>
                                                        <select id="district" class="form-select form-select-sm"
                                                            disabled>
                                                            <option value="">Select District</option>
                                                        </select>
                                                    </div>
                                                    <div class="text-center">
                                                        <p class="mt-3 mb-0" id="shipping-estimate">
                                                            <span class="text-muted">Select a province to see shipping
                                                                cost</span>
                                                        </p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Quantity Selector and Total Price -->
                                <div id="error-message" class="alert alert-danger d-none mb-4"></div>
                                <div class="mb-5">
                                    <div class="row">
                                        <div class="col-md-5">
                                            <label for="quantity" class="form-label fw-medium">Quantity:</label>
                                            <div class="input-group quantity-selector" style="width: 135px;">
                                                <button type="button" class="btn btn-outline-secondary" onclick="decrementQuantity()">
                                                    <i class="fas fa-minus"></i>
                                                </button>
                                                <input type="number" id="quantity" class="form-control text-center" value="1" min="1" max="99">
                                                <button type="button" class="btn btn-outline-secondary" onclick="incrementQuantity()">
                                                    <i class="fas fa-plus"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <div class="col-md-6 mt-3 mt-md-0">
                                            <div class="card bg-light border-0">
                                                <div class="card-body p-3">
                                                    <h6 class="mb-3 border-bottom pb-2">Order Summary</h6>
                                                    <div class="d-flex justify-content-between mb-2">
                                                        <span>Product Price:</span>
                                                        <span class="fw-medium product-price-display">
                                                            <span
                                                                th:if="${discount != null and discount.discountPct != null and product.price != null}"
                                                                th:text="${#numbers.formatDecimal(product.price * (100 - discount.discountPct) / 100, 0, 'POINT', 0, 'COMMA')} + ' VND'"
                                                                th:attr="data-price=${product.price * (100 - discount.discountPct) / 100}">
                                                            </span>
                                                            <span
                                                                th:unless="${discount != null and discount.discountPct != null and product.price != null}"
                                                                th:text="${#numbers.formatDecimal(product.price, 0, 'POINT', 0, 'COMMA')} + ' VND'"
                                                                th:attr="data-price=${product.price}">
                                                            </span>
                                                        </span>
                                                    </div>
                                                    <div class="d-flex justify-content-between mb-2">
                                                        <span>Shipping Fee:</span>
                                                        <span class="fw-medium shipping-cost" id="shipping-cost-display"
                                                            th:text="${#numbers.formatDecimal(shippingCost, 0, 'POINT', 0, 'COMMA')} + ' VND'"
                                                            th:attr="data-shipping=${shippingCost}"></span>
                                                    </div>
                                                    <div
                                                        class="d-flex justify-content-between fw-bold pt-2 border-top mt-2">
                                                        <span>Total:</span>
                                                        <span class="total-price"></span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Action Buttons -->
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <form th:action="@{/cart/add}" method="post" class="w-100" id="addToCartForm" onsubmit="return validateQuantity()">
                                            <input type="hidden" name="productId" th:value="${product.productId}" />
                                            <input type="hidden" name="quantity" id="cartQuantity" value="1" />
                                            <button type="submit" class="btn btn-action btn-cart w-100" id="cartBtn">
                                                <i class="fas fa-shopping-cart me-2"></i>Add to Cart
                                            </button>
                                        </form>
                                    </div>
                                    <div class="col-md-6">
                                        <form th:action="@{/cart/add}" method="post" class="w-100">
                                            <input type="hidden" name="productId" th:value="${product.productId}" />
                                            <input type="hidden" name="quantity" id="buyQuantity" value="1" />
                                            <button type="submit" class="btn btn-action btn-buy w-100">
                                                <i class="fas fa-bolt me-2"></i>Buy Now
                                            </button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                        <!-- Specifications Section -->
                        <div class="spec-desc-container">
                            <div class="spec-desc-tabs">
                                <div class="spec-desc-tab active" data-tab="specifications">Technical Specifications
                                </div>
                                <div class="spec-desc-tab" data-tab="description">Product Description</div>
                            </div>

                            <div class="spec-desc-content">
                                <!-- Panel Technical Specifications -->
                                <div class="specifications-panel spec-desc-panel active" id="specifications">
                                    <h3 class="section-title">Technical Specifications</h3>
                                    <table class="specs-table">
                                        <tr th:each="spec, specStat : ${specifications}"
                                            th:if="${specStat.index == 0 || !specifications[specStat.index-1].specKey.equals(spec.specKey)}">
                                            <th th:text="${spec.specKey}"></th>
                                            <td th:text="${spec.specValue}"></td>
                                        </tr>
                                    </table>
                                </div>

                                <!-- Panel Product Description -->
                                <div class="description-panel spec-desc-panel" id="description">
                                    <h3 class="section-title">Product Description</h3>
                                    <div class="description-content"
                                        th:utext="${product.description != null ? product.description : 'No description available for this product.'}">
                                    </div>
                                </div>
                            </div>
                        </div>


                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Address Selection Modal -->
    <div id="addressModal" class="address-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Select Delivery Address</h3>
                <span class="close-modal" onclick="closeAddressModal()">&times;</span>
            </div>

            <div class="modal-body">
                <!-- Default Address -->
                <div class="address-option" id="default-address" onclick="selectAddress(this)">
                    <div class="address-icon">
                        <i class="fas fa-home"></i>
                    </div>
                    <div class="address-text">
                        <h5>Default Address</h5>
                        <p id="default-address-text"
                            th:text="${customer.address != null ? customer.address : 'No default address set'}"></p>
                    </div>
                    <div class="address-actions">
                        <span class="badge bg-primary">Default</span>
                    </div>
                </div>

                <!-- Other Addresses -->
                <div class="address-option" id="new-address" onclick="selectAddress(this)">
                    <div class="address-icon">
                        <i class="fas fa-map-marker-alt"></i>
                    </div>
                    <div class="address-text">
                        <h5>Select New Address</h5>
                        <p>Choose a different delivery location for this order</p>
                        <p class="text-muted small mt-1">(This won't change your account default)</p>
                    </div>
                </div>

                <!-- Address Form (hidden by default) -->
                <div id="address-form" class="mt-4" style="display: none;">
                    <h5 class="mb-4">Enter Temporary Delivery Address</h5>
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        This address will only be used for this order and won't change your account settings.
                    </div>
                    <div class="mb-3">
                        <label for="new-province" class="form-label">Province/City</label>
                        <select id="new-province" class="form-select form-select-lg"
                            onchange="handleNewProvinceChange()">
                            <option value="">Select Province</option>
                            <!-- Will be populated by JavaScript -->
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="new-district" class="form-label">District</label>
                        <select id="new-district" class="form-select form-select-lg" disabled>
                            <option value="">Select District</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="new-street" class="form-label">Street Address</label>
                        <input type="text" id="new-street" class="form-control form-control-lg"
                            placeholder="Enter street address">
                    </div>
                    <div class="d-flex justify-content-end mt-4">
                        <button type="button" class="btn btn-outline-secondary me-2" onclick="cancelAddressChange()">
                            Cancel
                        </button>
                        <button type="button" class="btn btn-save-address" onclick="saveTemporaryAddress()">Use This
                            Address
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Define productDetails from server data
        const productDetails = {
            productId: [[${product.productId}]],
            name: '[[${product.name}]]',
            price: [[${product.price}]],
            imageUrl: '[[${primaryImage}]]'
        };
        
        console.log('Product details loaded:', productDetails);
        
        // Ensure productDetails has valid data
        if (!productDetails.productId || productDetails.productId === 0) {
            alert('Lỗi: Không lấy được mã sản phẩm. Wishlist sẽ không hoạt động!');
        }

        // Function to change main product image
        function changeMainImage(event) {
            const mainImage = document.getElementById('mainProductImage');
            mainImage.src = event.target.src;
            mainImage.alt = event.target.alt;

            // Update active thumbnail
            document.querySelectorAll('.product-thumbnail').forEach(img => {
                img.classList.remove('active');
            });
            event.target.classList.add('active');

            // Smooth transition effect
            mainImage.style.opacity = 0;
            setTimeout(() => {
                mainImage.style.opacity = 1;
                mainImage.style.transition = 'opacity 0.3s ease';
            }, 10);
        }

        // Quantity selector functionality
        function decrementQuantity() {
            const input = document.getElementById('quantity');
            const currentValue = parseInt(input.value);
            if (currentValue > 1) {
                input.value = currentValue - 1;
                updateFormQuantities(currentValue - 1);
                updateTotalPrice(currentValue - 1);
            }
        }

        function incrementQuantity() {
            const input = document.getElementById('quantity');
            const currentValue = parseInt(input.value);
            if (currentValue < 99) {
                input.value = currentValue + 1;
                updateFormQuantities(currentValue + 1);
                updateTotalPrice(currentValue + 1);
            }
        }

        function updateFormQuantities(value) {
            document.getElementById('cartQuantity').value = value;
            document.getElementById('buyQuantity').value = value;
        }

        function updateTotalPrice(quantity) {
            // Get product price
            const priceElement = document.querySelector('.product-price-display span');
            const productPrice = parseFloat(priceElement.getAttribute('data-price'));

            // Get shipping cost
            const shippingElement = document.getElementById('shipping-cost-display');
            const shippingCost = parseFloat(shippingElement.getAttribute('data-shipping'));

            // Calculate total
            const total = (productPrice * quantity) + shippingCost;

            // Format with comma for thousands
            const formattedTotal = new Intl.NumberFormat('vi-VN').format(total);

            // Update total price display
            document.querySelector('.total-price').textContent = formattedTotal + ' VND';
        }

        // Wishlist functions
        function getWishlist() {
            try {
                return JSON.parse(localStorage.getItem('wishlist')) || [];
            } catch (e) {
                console.error('Error reading wishlist:', e);
                return [];
            }
        }

        function saveWishlist(wishlist) {
            localStorage.setItem('wishlist', JSON.stringify(wishlist));
        }

        function isInWishlist(productId) {
            const wishlist = getWishlist();
            return wishlist.some(p => p.productId === productId);
        }

        function updateWishlistIcon(productId) {
            const wishlistBtn = document.getElementById('wishlistBtn');
            if (!wishlistBtn) {
                console.error('Wishlist button not found');
                return;
            }

            const heartIcon = wishlistBtn.querySelector('i');
            if (!heartIcon) {
                console.error('Heart icon not found');
                return;
            }
            
            if (isInWishlist(productId)) {
                wishlistBtn.classList.add('active');
                heartIcon.classList.remove('far');
                heartIcon.classList.add('fas');
                console.log('Product is in wishlist, icon updated to filled heart');
            } else {
                wishlistBtn.classList.remove('active');
                heartIcon.classList.remove('fas');
                heartIcon.classList.add('far');
                console.log('Product is not in wishlist, icon updated to empty heart');
            }
        }

        function toggleWishlist() {
            console.log('Toggle wishlist clicked for product:', productDetails);
            
            if (!productDetails || !productDetails.productId) {
                console.error('Invalid product details');
                return;
            }
            
            let wishlist = getWishlist();
            const idx = wishlist.findIndex(p => p.productId === productDetails.productId);

            if (idx === -1) {
                wishlist.push(productDetails);
                showFloatingMessage('Added to wishlist');
                console.log('Product added to wishlist');
            } else {
                wishlist.splice(idx, 1);
                showFloatingMessage('Removed from wishlist');
                console.log('Product removed from wishlist');
            }

            saveWishlist(wishlist);
            updateWishlistIcon(productDetails.productId);
            window.dispatchEvent(new Event('wishlist-updated'));
        }

        function validateQuantity() {
            const quantity = parseInt(document.getElementById('quantity').value);
            const stock = parseInt(document.getElementById('stock-display').textContent);
            const errorMessage = document.getElementById('error-message');

            errorMessage.classList.add('d-none');

            if (quantity > 99) {
                errorMessage.textContent = "You cannot add more than 99 items";
                errorMessage.classList.remove('d-none');
                return false;
            }

            if (quantity > stock) {
                errorMessage.textContent = "Not enough stock. Only " + stock + " items available";
                errorMessage.classList.remove('d-none');
                return false;
            }

            return true;
        }

        // Sửa hàm incrementQuantity để kiểm tra stock
        function incrementQuantity() {
            const input = document.getElementById('quantity');
            const currentValue = parseInt(input.value);
            const stock = parseInt(document.getElementById('stock-display').textContent);

            if (currentValue < 99 && currentValue < stock) {
                input.value = currentValue + 1;
                updateFormQuantities(currentValue + 1);
                updateTotalPrice(currentValue + 1);
            } else {
                const errorMessage = document.getElementById('error-message');
                if (currentValue >= 99) {
                    errorMessage.textContent = "You cannot add more than 99 items";
                } else {
                    errorMessage.textContent = "Not enough stock. Only " + stock + " items available";
                }
                errorMessage.classList.remove('d-none');
            }
        }

        // Sửa hàm decrementQuantity
        function decrementQuantity() {
            const input = document.getElementById('quantity');
            const currentValue = parseInt(input.value);

            if (currentValue > 1) {
                input.value = currentValue - 1;
                updateFormQuantities(currentValue - 1);
                updateTotalPrice(currentValue - 1);
            }

            // Ẩn thông báo lỗi nếu có
            document.getElementById('error-message').classList.add('d-none');
        }

        // Thêm kiểm tra khi thay đổi giá trị nhập
        document.getElementById('quantity').addEventListener('change', function() {
            const value = parseInt(this.value);
            const stock = parseInt(document.getElementById('stock-display').textContent);
            const errorMessage = document.getElementById('error-message');

            if (value > 99 || value > stock) {
                if (value > 99) {
                    errorMessage.textContent = "You cannot add more than 99 items";
                } else {
                    errorMessage.textContent = "Not enough stock. Only " + stock + " items available";
                }
                errorMessage.classList.remove('d-none');
                this.value = Math.min(99, stock);
            } else {
                errorMessage.classList.add('d-none');
            }

            updateFormQuantities(this.value);
            updateTotalPrice(this.value);
        });

        // Show floating message
        function showFloatingMessage(message) {
            const floatingMessage = document.getElementById('floatingMessage');
            const messageText = document.getElementById('messageText');
            messageText.textContent = message;
            floatingMessage.classList.add('show');
            setTimeout(() => floatingMessage.classList.remove('show'), 3000);
        }

        // Animation for adding to cart
        function animateToCart() {
            const productImage = document.getElementById('mainProductImage');
            const cartBtn = document.getElementById('cartBtn');

            // Create a clone of the product image
            const clone = productImage.cloneNode(true);
            clone.classList.add('animate-to-cart');
            clone.style.position = 'fixed';
            clone.style.top = productImage.getBoundingClientRect().top + 'px';
            clone.style.left = productImage.getBoundingClientRect().left + 'px';
            clone.style.width = productImage.offsetWidth + 'px';
            clone.style.height = productImage.offsetHeight + 'px';
            clone.style.zIndex = '1000';

            document.body.appendChild(clone);

            // Remove the clone after animation completes
            setTimeout(() => {
                clone.remove();
                showFloatingMessage('Added to cart!');
            }, 1000);
        }

        // Address Modal Functions
        function openAddressModal() {
            document.getElementById('addressModal').style.display = 'block';
        }

        function closeAddressModal() {
            document.getElementById('addressModal').style.display = 'none';
        }

        function selectAddress(element) {
            // Remove selected class from all options
            document.querySelectorAll('.address-option').forEach(opt => {
                opt.classList.remove('selected');
            });

            // Add selected class to clicked option
            element.classList.add('selected');

            // If "New Address" is selected, show the form
            if (element.id === 'new-address') {
                document.getElementById('address-form').style.display = 'block';
                loadNewProvinces();
            } else {
                document.getElementById('address-form').style.display = 'none';
            }
        }

        function cancelAddressChange() {
            document.getElementById('address-form').style.display = 'none';
            document.querySelectorAll('.address-option').forEach(opt => {
                opt.classList.remove('selected');
            });
        }

        function saveTemporaryAddress() {
            const province = document.getElementById('new-province');
            const district = document.getElementById('new-district');
            const street = document.getElementById('new-street');

            if (!province.value || !district.value || !street.value) {
                alert('Please fill in all address fields');
                return;
            }

            const provinceText = province.options[province.selectedIndex].text;
            const districtText = district.options[district.selectedIndex].text;
            const fullAddress = `${street.value}, ${districtText}, ${provinceText}`;

            // Update displayed address
            document.getElementById('displayed-address').innerHTML =
                `<span>${fullAddress}</span> <span class="temporary-badge">Temporary</span>`;

            // Show temporary badge
            document.getElementById('temporary-badge').style.display = 'inline';

            // Calculate new shipping cost
            const newShippingCost = calculateShippingCostByProvince(provinceText);

            // Update shipping cost display
            const formattedShipping = new Intl.NumberFormat('vi-VN').format(newShippingCost);
            document.getElementById('shipping-fee').textContent = formattedShipping + ' VND';
            document.getElementById('shipping-cost-display').textContent = formattedShipping + ' VND';
            document.getElementById('shipping-cost-display').setAttribute('data-shipping', newShippingCost);

            // Update shipping info display
            if (newShippingCost === 0) {
                document.getElementById('shipping-info').innerHTML = `
                <i class="fas fa-check-circle text-success me-2"></i>
                <span class="fw-medium text-success">Free shipping</span>
            `;
            } else {
                document.getElementById('shipping-info').innerHTML = `
                <i class="fas fa-truck text-primary me-2"></i>
                <span class="fw-medium">Shipping fee: <span>${formattedShipping} VND</span></span>
            `;
            }

            // Update total price
            const quantity = parseInt(document.getElementById('quantity').value);
            updateTotalPrice(quantity);

            // Close modal
            closeAddressModal();
        }

        function calculateShippingCostByProvince(province) {
            // Simplified shipping cost calculation
            const provinceLower = province.toLowerCase();

            if (provinceLower.includes("cần thơ") || provinceLower.includes("can tho")) {
                return 0;
            }

            // List of northern provinces
            const northernProvinces = [
                "hà nội", "hanoi", "hải phòng", "haiphong", "bắc ninh", "bắc giang", "lào cai",
                "lao cai", "điện biên", "dien bien", "hòa bình", "hoa binh", "lai châu", "lai chau",
                "sơn la", "son la", "hà giang", "ha giang", "cao bằng", "cao bang", "bắc kạn", "bac kan",
                "lạng sơn", "lang son", "tuyên quang", "tuyen quang", "thái nguyên", "thai nguyen",
                "phú thọ", "phu tho", "vĩnh phúc", "vinh phuc", "quảng ninh", "quang ninh",
                "hải dương", "hai duong", "hưng yên", "hung yen", "thái bình", "thai binh",
                "hà nam", "ha nam", "nam định", "nam dinh", "ninh bình", "ninh binh", "thanh hóa", "thanh hoa"
            ];

            // Check if province is in northern list
            const isNorthern = northernProvinces.some(p => provinceLower.includes(p));

            return isNorthern ? 40000 : 20000;
        }

        async function loadNewProvinces() {
            try {
                const response = await fetch('https://provinces.open-api.vn/api/?depth=1');
                const data = await response.json();
                const provinceSelect = document.getElementById('new-province');

                if (provinceSelect) {
                    provinceSelect.innerHTML = '<option value="">Select Province</option>';
                    data.forEach(province => {
                        const option = document.createElement('option');
                        option.value = province.code;
                        option.textContent = province.name;
                        provinceSelect.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading provinces:', error);
            }
        }

        async function handleNewProvinceChange() {
            const provinceSelect = document.getElementById('new-province');
            const districtSelect = document.getElementById('new-district');
            const provinceCode = provinceSelect.value;

            if (!provinceCode) {
                districtSelect.disabled = true;
                districtSelect.innerHTML = '<option value="">Select District</option>';
                return;
            }

            try {
                const response = await fetch(`https://provinces.open-api.vn/api/p/${provinceCode}?depth=2`);
                const provinceData = await response.json();

                districtSelect.innerHTML = '<option value="">Select District</option>';
                provinceData.districts.forEach(district => {
                    const option = document.createElement('option');
                    option.value = district.code;
                    option.textContent = district.name;
                    districtSelect.appendChild(option);
                });

                districtSelect.disabled = false;
            } catch (error) {
                console.error('Error loading districts:', error);
            }
        }

        // Close modal when clicking outside
        window.onclick = function (event) {
            const modal = document.getElementById('addressModal');
            if (event.target === modal) {
                closeAddressModal();
            }
        }

        // Initialize everything when DOM is loaded
        document.addEventListener('DOMContentLoaded', function () {
            console.log('DOM loaded, initializing wishlist for product:', productDetails.productId);
            // Initialize wishlist icon
            updateWishlistIcon(productDetails.productId);

            // Initialize quantity functionality
            const quantityInput = document.getElementById('quantity');
            if (quantityInput) {
                // Calculate initial total price
                updateTotalPrice(1);

                quantityInput.addEventListener('change', function () {
                    let value = parseInt(this.value);
                    if (isNaN(value) || value < 1) value = 1;
                    if (value > 99) value = 99;
                    this.value = value;
                    updateFormQuantities(value);
                    updateTotalPrice(value);
                });
            }

            // Smooth scroll to specifications when clicking the "See all" link
            const specLink = document.querySelector('a[href="#specifications"]');
            if (specLink) {
                specLink.addEventListener('click', function (e) {
                    e.preventDefault();
                    document.getElementById('specifications').scrollIntoView({
                        behavior: 'smooth'
                    });
                });
            }

            // Add event listener for cart button
            const addToCartForm = document.getElementById('addToCartForm');
            if (addToCartForm) {
                addToCartForm.addEventListener('submit', function (e) {
                    e.preventDefault();
                    animateToCart();

                    // Submit form via AJAX
                    const formData = new FormData(this);
                    fetch('/cart/add', {
                        method: 'POST',
                        body: formData
                    })
                        .then(response => {
                            if (response.ok) {
                                // Update cart count in navigation
                                if (window.updateCartCount) {
                                    window.updateCartCount();
                                }
                                // Trigger custom event
                                document.dispatchEvent(new Event('cartUpdated'));
                            }
                        })
                        .catch(error => {
                            console.error('Error adding to cart:', error);
                        });
                });
            }

            // Initialize tabs functionality
            const tabs = document.querySelectorAll('.spec-desc-tab');
            const panels = document.querySelectorAll('.spec-desc-panel');

            tabs.forEach(tab => {
                tab.addEventListener('click', function () {
                    const tabType = this.getAttribute('data-tab');

                    // Cập nhật active tab
                    tabs.forEach(t => t.classList.remove('active'));
                    this.classList.add('active');

                    // Ẩn tất cả các panel
                    panels.forEach(panel => panel.classList.remove('active'));

                    // Hiển thị panel được chọn với hiệu ứng
                    setTimeout(() => {
                        const activePanel = document.getElementById(tabType);
                        if (activePanel) {
                            activePanel.classList.add('active');
                        }
                    }, 10);
                });
            });

            // Xử lý cho nút "See all"
            const seeAllLink = document.querySelector('a[href="#specifications"]');
            if (seeAllLink) {
                seeAllLink.addEventListener('click', function (e) {
                    e.preventDefault();

                    // Kích hoạt tab Specifications
                    const specTab = document.querySelector('.spec-desc-tab[data-tab="specifications"]');
                    if (specTab) {
                        specTab.click();
                    }

                    // Scroll đến phần này
                    document.querySelector('.spec-desc-container').scrollIntoView({
                        behavior: 'smooth'
                    });
                });
            }
        });
    </script>
</body>

</html>