<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Kết quả tìm kiếm</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" th:href="@{/css/navigationBar.css}">
    <link rel="stylesheet" th:href="@{/css/search.css}">
    <link rel="stylesheet" th:href="@{/css/autocomplete.css}">
    <style>
        .filter-tag {
            display: inline-block;
            background: #0074d9;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            margin: 2px;
            font-size: 0.85rem;
        }
        .filter-tag .remove {
            margin-left: 8px;
            cursor: pointer;
        }
        .product-card {
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .product-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .loading-spinner {
            display: none;
            text-align: center;
            padding: 20px;
        }
        .lazy-image {
            opacity: 0;
            transition: opacity 0.3s;
        }
        .lazy-image.loaded {
            opacity: 1;
        }
    </style>
</head>
<body>
<div th:replace="fragments/navigationBar :: navBar"></div>
<div class="container mt-4">
    <h2 class="mb-3">Kết quả tìm kiếm cho: <span th:text="${keyword}"></span></h2>
    
    <!-- Filter Tags -->
    <div id="filterTags" class="mb-3" th:if="${keyword != null || categoryId != null || brandId != null || minPrice != null || maxPrice != null}">
        <small class="text-muted">Bộ lọc đang áp dụng:</small><br>
        <span th:if="${keyword != null}" class="filter-tag">
            Từ khóa: <span th:text="${keyword}"></span>
            <span class="remove" onclick="removeFilter('keyword')">&times;</span>
        </span>
        <span th:if="${categoryId != null}" class="filter-tag">
            Danh mục: <span th:text="${categories.?[id == categoryId].name[0]}"></span>
            <span class="remove" onclick="removeFilter('categoryId')">&times;</span>
        </span>
        <span th:if="${brandId != null}" class="filter-tag">
            Thương hiệu: <span th:text="${brands.?[id == brandId].name[0]}"></span>
            <span class="remove" onclick="removeFilter('brandId')">&times;</span>
        </span>
        <span th:if="${minPrice != null || maxPrice != null}" class="filter-tag">
            Giá: <span th:text="${minPrice != null ? #numbers.formatInteger(minPrice, 0) : '0'}"></span> - 
            <span th:text="${maxPrice != null ? #numbers.formatInteger(maxPrice, 0) : '∞'}"></span> VND
            <span class="remove" onclick="removeFilter('price')">&times;</span>
        </span>
    </div>
    
    <form th:action="@{/search}" method="get" class="row g-3 align-items-end mb-3">
        <input type="hidden" name="keyword" th:value="${keyword}">
        <div class="col-md-3">
            <select class="form-select" name="categoryId">
                <option value="">Tất cả danh mục</option>
                <option th:each="category : ${categories}" th:value="${category.id}" th:text="${category.name}" th:selected="${categoryId == category.id}"></option>
            </select>
        </div>
        <div class="col-md-3">
            <select class="form-select" name="brandId">
                <option value="">Tất cả thương hiệu</option>
                <option th:each="brand : ${brands}" th:value="${brand.id}" th:text="${brand.name}" th:selected="${brandId == brand.id}"></option>
            </select>
        </div>
        <div class="col-md-2">
            <input type="number" class="form-control" name="minPrice" th:value="${minPrice}" placeholder="Giá từ (VND)">
        </div>
        <div class="col-md-2">
            <input type="number" class="form-control" name="maxPrice" th:value="${maxPrice}" placeholder="Đến (VND)">
        </div>
        <div class="col-md-2">
            <select class="form-select" name="sortOption">
                <option value="default" th:selected="${sortOption == null || sortOption == 'default'}">Mặc định</option>
                <option value="name_asc" th:selected="${sortOption == 'name_asc'}">Tên (A-Z)</option>
                <option value="name_desc" th:selected="${sortOption == 'name_desc'}">Tên (Z-A)</option>
                <option value="price_asc" th:selected="${sortOption == 'price_asc'}">Giá tăng dần</option>
                <option value="price_desc" th:selected="${sortOption == 'price_desc'}">Giá giảm dần</option>
            </select>
        </div>
        <div class="col-md-2">
            <button type="submit" class="btn btn-primary w-100">
                <i class="fas fa-search"></i> Lọc
            </button>
        </div>
    </form>
    
    <div th:if="${priceError != null}" class="alert alert-danger">[[${priceError}]]</div>
    
    <!-- Loading Spinner -->
    <div id="loadingSpinner" class="loading-spinner">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-2">Đang tải kết quả...</p>
    </div>
    
    <div class="row" id="productContainer">
        <div th:if="${#lists.isEmpty(products)}" class="text-center py-5">
            <i class="fas fa-box-open fa-3x text-muted mb-3"></i>
            <h5 class="text-muted">Không tìm thấy sản phẩm phù hợp</h5>
            <p class="text-muted">Thử thay đổi từ khóa hoặc bộ lọc</p>
        </div>
        <div th:each="product : ${products}" class="col-6 col-sm-4 col-md-3 mb-3 d-flex">
            <div class="product-card w-100 position-relative">
                <a th:href="@{'/Product/' + ${product.productId}}" style="text-decoration:none; color:inherit; display:block;">
                    <img th:if="${product.imageUrl}" th:src="${product.imageUrl}" th:alt="${product.name}" 
                         class="product-img lazy-image" loading="lazy" 
                         onload="this.classList.add('loaded')" 
                         onerror="this.src='/images/default-product.png'">
                    <h5 class="product-title" th:text="${product.name}" style="color:#2196f3; font-size:1.1rem; font-weight:400; margin-bottom:4px;">Tên sản phẩm</h5>
                    <div>
                        <span style="color:#e53935; font-size:1.1rem; font-weight:700;" th:text="${#numbers.formatDecimal(product.price, 0, 'POINT', 0, 'COMMA')}"></span>
                        <span style="color:#e53935; font-size:0.85rem; font-weight:700; vertical-align:super;">VND</span>
                    </div>
                </a>
            </div>
        </div>
    </div>
    
    <!-- Pagination -->
    <div th:if="${totalPages > 1}" class="d-flex justify-content-center mt-4">
        <ul class="pagination">
            <li class="page-item" th:classappend="${currentPage == 0} ? 'disabled'">
                <a class="page-link" th:href="@{/search(page=0, size=${size}, keyword=${keyword}, categoryId=${categoryId}, brandId=${brandId}, minPrice=${minPrice}, maxPrice=${maxPrice}, sortOption=${sortOption})}">&laquo;</a>
            </li>
            <li class="page-item" th:each="i : ${#numbers.sequence(0, totalPages-1)}" th:classappend="${currentPage == i} ? 'active'">
                <a class="page-link" th:href="@{/search(page=${i}, size=${size}, keyword=${keyword}, categoryId=${categoryId}, brandId=${brandId}, minPrice=${minPrice}, maxPrice=${maxPrice}, sortOption=${sortOption})}" th:text="${i+1}"></a>
            </li>
            <li class="page-item" th:classappend="${currentPage == (totalPages - 1)} ? 'disabled'">
                <a class="page-link" th:href="@{/search(page=${totalPages - 1}, size=${size}, keyword=${keyword}, categoryId=${categoryId}, brandId=${brandId}, minPrice=${minPrice}, maxPrice=${maxPrice}, sortOption=${sortOption})}">&raquo;</a>
            </li>
        </ul>
    </div>
</div>

<script>
// Show loading spinner when form is submitted
document.querySelector('form').addEventListener('submit', function() {
    document.getElementById('loadingSpinner').style.display = 'block';
    document.getElementById('productContainer').style.display = 'none';
});

// Remove filter function
function removeFilter(filterType) {
    const url = new URL(window.location);
    if (filterType === 'keyword') {
        url.searchParams.delete('keyword');
    } else if (filterType === 'categoryId') {
        url.searchParams.delete('categoryId');
    } else if (filterType === 'brandId') {
        url.searchParams.delete('brandId');
    } else if (filterType === 'price') {
        url.searchParams.delete('minPrice');
        url.searchParams.delete('maxPrice');
    }
    window.location.href = url.toString();
}

// Lazy loading for images
document.addEventListener('DOMContentLoaded', function() {
    const images = document.querySelectorAll('.lazy-image');
    const imageObserver = new IntersectionObserver((entries, observer) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                const img = entry.target;
                img.src = img.dataset.src || img.src;
                observer.unobserve(img);
            }
        });
    });
    
    images.forEach(img => imageObserver.observe(img));
});
</script>
<script src="/js/autocomplete.js"></script>
</body>
</html> 